<!DOCTYPE html>
<html>
<head>
    <title>Keep Score</title>
    <style>
        body { font-family: Arial, sans-serif; }
        .team { margin-bottom: 30px; padding: 10px; border-radius: 5px; }
        .team-a { background-color: #ffcccc; }
        .team-b { background-color: #cce0ff; }
        h2 { margin-bottom: 10px; }
        .player { margin-bottom: 5px; }
        .score { font-weight: bold; margin-left: 10px; }
        button { padding: 5px 10px; margin-left: 5px; cursor: pointer; }
        #scoreboard { font-size: 20px; margin-bottom: 20px; }
        #game-over { margin-top: 20px; padding: 10px 20px; font-size: 16px; }
    </style>
</head>
<body>
    <h1>Keep Score</h1>

    <div id="scoreboard">
        Team A: <span id="team-a-total">0</span> - 
        Team B: <span id="team-b-total">0</span>
    </div>

    <div class="team team-a">
        <h2>Team A</h2>
        {% for player in team_a %}
        <div class="player" data-player="{{ player }}" data-team="A">
            {{ player }}: 
            1pt <span class="score1">0</span>, 
            2pt <span class="score2">0</span>, 
            Total <span class="score-total">0</span>
            <button onclick="addScore('{{ player }}', 'A', 1)">+1</button>
            <button onclick="addScore('{{ player }}', 'A', 2)">+2</button>
            <button onclick="removeScore('{{ player }}', 'A', 1)">-1</button>
            <button onclick="removeScore('{{ player }}', 'A', 2)">-2</button>
        </div>
        {% endfor %}
    </div>

    <div class="team team-b">
        <h2>Team B</h2>
        {% for player in team_b %}
        <div class="player" data-player="{{ player }}" data-team="B">
            {{ player }}: 
            1pt <span class="score1">0</span>, 
            2pt <span class="score2">0</span>, 
            Total <span class="score-total">0</span>
            <button onclick="addScore('{{ player }}', 'B', 1)">+1</button>
            <button onclick="addScore('{{ player }}', 'B', 2)">+2</button>
            <button onclick="removeScore('{{ player }}', 'B', 1)">-1</button>
            <button onclick="removeScore('{{ player }}', 'B', 2)">-2</button>
        </div>
        {% endfor %}
    </div>

    <button id="game-over" onclick="confirmGameOver()">Game Over</button>

    <script>
        const playerScores = {};
        let teamTotals = { A: 0, B: 0 };

        function addScore(player, team, points){
            if(!playerScores[player]) playerScores[player] = {points_1: 0, points_2: 0, total_points: 0};

            if(points === 1) playerScores[player].points_1 += 1;
            else if(points === 2) playerScores[player].points_2 += 1;

            playerScores[player].total_points += points;
            teamTotals[team] += points;

            updateUI(player, team);
        }

        function removeScore(player, team, points){
            if(!playerScores[player]) return;

            if(points === 1 && playerScores[player].points_1 > 0){
                playerScores[player].points_1 -= 1;
                playerScores[player].total_points -= 1;
                teamTotals[team] -= 1;
            } 
            else if(points === 2 && playerScores[player].points_2 > 0){
                playerScores[player].points_2 -= 1;
                playerScores[player].total_points -= 2;
                teamTotals[team] -= 2;
            }

            updateUI(player, team);
        }

        function updateUI(player, team){
            const playerDiv = document.querySelector(`.player[data-player='${player}']`);
            playerDiv.querySelector(".score1").textContent = playerScores[player].points_1;
            playerDiv.querySelector(".score2").textContent = playerScores[player].points_2;
            playerDiv.querySelector(".score-total").textContent = playerScores[player].total_points;

            document.getElementById("team-a-total").textContent = teamTotals['A'];
            document.getElementById("team-b-total").textContent = teamTotals['B'];
        }

        function confirmGameOver(){
            let winner = teamTotals['A'] > teamTotals['B'] ? 'Team A' : 'Team B';
            let message = `${winner} wins!\nFinal Score:\nTeam A: ${teamTotals['A']} - Team B: ${teamTotals['B']}\nConfirm?`;

            if(confirm(message)){
                finalizeGame();
            }
        }

        function finalizeGame(){
            fetch("/finalize_game", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(playerScores)
            }).then(res => res.json())
              .then(data => {
                  alert("Game finalized! Scores saved.");
                  window.location.href = "/leaderboard"; // redirect to leaderboard after confirmation
              })
              .catch(err => {
                  alert("Error saving game: " + err);
              });
        }
    </script>
</body>
</html>
